<nz-card nzTitle="Secretary Approval Overview" [nzExtra]="extraTemplate">
  <nz-spin [nzSpinning]="loading()">
    <!-- Status summary for admin/director -->
    @if (isAdminOrDirector()) {
      <div class="status-summary">
        <nz-tag nzColor="gold" class="summary-tag" (click)="statusFilter.set('PENDING')">
          <strong>{{ pendingCount() }}</strong> Not Approved
        </nz-tag>
        <nz-tag nzColor="green" class="summary-tag" (click)="statusFilter.set('APPROVED')">
          <strong>{{ approvedCount() }}</strong> Approved
        </nz-tag>
        <nz-tag nzColor="default" class="summary-tag" (click)="statusFilter.set('ALL')">
          <strong>{{ tickets().length }}</strong> Total
        </nz-tag>
      </div>
    }

    <div class="filter-bar">
      <nz-select
        [(ngModel)]="statusFilter"
        nzPlaceHolder="Filter by approval status"
        style="width: 220px"
      >
        <nz-option nzValue="ALL" nzLabel="All Tickets"></nz-option>
        <nz-option nzValue="PENDING" nzLabel="⏳ Not Approved by Secretary"></nz-option>
        <nz-option nzValue="APPROVED" nzLabel="✓ Approved by Secretary"></nz-option>
      </nz-select>
    </div>

    <div class="table-wrapper">
      <nz-table
        #ticketTable
        [nzData]="filteredTickets()"
        [nzShowPagination]="true"
        [nzPageSize]="10"
        [nzSize]="'middle'"
      >
        <thead>
          <tr>
            <th>Ticket #</th>
            <th>Type</th>
            <th>Title</th>
            <th>Ticket Status</th>
            <th>Secretary Approval</th>
            <th>Priority</th>
            <th>Requester</th>
            <th>Created</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          @if (filteredTickets().length === 0) {
            <tr>
              <td colspan="9">
                <nz-empty nzNotFoundContent="No tickets found"></nz-empty>
              </td>
            </tr>
          }
          @for (ticket of ticketTable.data; track ticket.id) {
            <tr [class.pending-row]="!ticket.secretaryApprovedAt">
              <td>
                <a [routerLink]="['/tickets', ticket.ticketNumber]">
                  {{ ticket.ticketNumber }}
                </a>
              </td>
              <td>
                <nz-tag [nzColor]="ticket.type === 'MIS' ? 'blue' : 'green'">
                  {{ ticket.type }}
                </nz-tag>
              </td>
              <td>{{ ticket.title }}</td>
              <td>
                <nz-tag [nzColor]="getStatusColor(ticket.status)">
                  {{ ticket.status.replace('_', ' ') }}
                </nz-tag>
              </td>
              <td>
                @if (ticket.secretaryApprovedAt) {
                  <nz-tag nzColor="green">✓ Approved</nz-tag>
                  <small class="approval-date">{{ ticket.secretaryApprovedAt | date:'short' }}</small>
                } @else {
                  <nz-tag nzColor="gold">⏳ Pending</nz-tag>
                }
              </td>
              <td>
                <nz-tag [nzColor]="getPriorityColor(ticket.priority)">
                  {{ ticket.priority }}
                </nz-tag>
              </td>
              <td>{{ ticket.createdBy.name || 'Unknown' }}</td>
              <td>{{ ticket.createdAt | date }}</td>
              <td>
                @if (!ticket.secretaryApprovedAt && isSecretary()) {
                  <button
                    nz-button
                    nzType="primary"
                    nzSize="small"
                    (click)="approveTicket(ticket.id)"
                  >
                    Approve
                  </button>
                }
                <a nz-button nzType="link" nzSize="small" [routerLink]="['/tickets', ticket.ticketNumber]">
                  View
                </a>
              </td>
            </tr>
          }
        </tbody>
      </nz-table>
    </div>
  </nz-spin>
</nz-card>

<ng-template #extraTemplate>
  <button nz-button nzType="default" (click)="loadTicketsForApproval()">
    Refresh
  </button>
</ng-template>
