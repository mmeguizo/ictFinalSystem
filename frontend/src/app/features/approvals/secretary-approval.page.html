<nz-card nzTitle="Secretary Review Overview" [nzExtra]="extraTemplate">
  <nz-spin [nzSpinning]="loading()">
    <!-- Status summary for admin/director/secretary -->
    @if (isAdminOrDirector() || isSecretary()) {
      <div class="status-summary">
        <nz-tag nzColor="gold" class="summary-tag" (click)="statusFilter.set('FOR_REVIEW')">
          <strong>{{ pendingCount() }}</strong> For Review
        </nz-tag>
        <nz-tag nzColor="green" class="summary-tag" (click)="statusFilter.set('REVIEWED')">
          <strong>{{ reviewedCount() }}</strong> Reviewed
        </nz-tag>
        <nz-tag nzColor="red" class="summary-tag" (click)="statusFilter.set('CANCELLED')">
          <strong>{{ rejectedCount() }}</strong> Rejected
        </nz-tag>
        <nz-tag nzColor="default" class="summary-tag" (click)="statusFilter.set('ALL')">
          <strong>{{ tickets().length }}</strong> Total
        </nz-tag>
      </div>
    }

    <div class="filter-bar">
      <nz-select
        [ngModel]="statusFilter()"
        (ngModelChange)="statusFilter.set($event)"
        nzPlaceHolder="Filter by review status"
        style="width: 220px"
      >
        <nz-option nzValue="ALL" nzLabel="All Tickets"></nz-option>
        <nz-option nzValue="FOR_REVIEW" nzLabel="⏳ For Review"></nz-option>
        <nz-option nzValue="REVIEWED" nzLabel="✓ Reviewed"></nz-option>
        <nz-option nzValue="CANCELLED" nzLabel="✗ Rejected"></nz-option>
      </nz-select>
    </div>

    <div class="table-wrapper">
      <nz-table
        #ticketTable
        [nzData]="filteredTickets()"
        [nzShowPagination]="true"
        [nzPageSize]="10"
        [nzSize]="'middle'"
      >
        <thead>
          <tr>
            <th>Ticket #</th>
            <th>Type</th>
            <th>Title</th>
            <th>Ticket Status</th>
            <th>Secretary Review</th>
            <th>Priority</th>
            <th>Requester</th>
            <th>Created</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          @if (filteredTickets().length === 0) {
            <tr>
              <td colspan="9">
                <nz-empty nzNotFoundContent="No tickets found"></nz-empty>
              </td>
            </tr>
          }
          @for (ticket of ticketTable.data; track ticket.id) {
            <tr [class.for-review-row]="!ticket.secretaryReviewedAt">
              <td>
                <a [routerLink]="['/tickets', ticket.ticketNumber]">
                  {{ ticket.ticketNumber }}
                </a>
              </td>
              <td>
                <nz-tag [nzColor]="ticket.type === 'MIS' ? 'blue' : 'green'">
                  {{ ticket.type }}
                </nz-tag>
              </td>
              <td>{{ ticket.title }}</td>
              <td>
                <nz-tag [nzColor]="getStatusColor(ticket.status)">
                  {{ ticket.status.replace('_', ' ') }}
                </nz-tag>
              </td>
              <td>
                @if (ticket.status === 'CANCELLED') {
                  <nz-tag nzColor="red">✗ Rejected</nz-tag>
                } @else if (ticket.secretaryReviewedAt) {
                  <nz-tag nzColor="green">✓ Reviewed</nz-tag>
                  <small class="review-date">{{ ticket.secretaryReviewedAt | date:'short' }}</small>
                } @else {
                  <nz-tag nzColor="gold">⏳ For Review</nz-tag>
                }
              </td>
              <td>
                <nz-tag [nzColor]="getPriorityColor(ticket.priority)">
                  {{ ticket.priority }}
                </nz-tag>
              </td>
              <td>{{ ticket.createdBy.name || 'Unknown' }}</td>
              <td>{{ ticket.createdAt | date }}</td>
              <td>
                <!-- Secretary Review Button - opens modal with approve/reject options -->
                <!-- Admin can also review as secretary -->
                @if (!ticket.secretaryReviewedAt && ticket.status === 'FOR_REVIEW' && (isSecretary() || isAdminOrDirector())) {
                  <button
                    nz-button
                    nzType="primary"
                    nzSize="small"
                    nz-tooltip="Review this ticket (approve or reject with notes)"
                    (click)="openReviewModal(ticket.id)"
                  >
                    Review
                  </button>
                }
                <!-- Director/Admin Approve Button - only shows for REVIEWED tickets -->
                @if (canApprove(ticket) && isAdminOrDirector()) {
                  <button
                    nz-button
                    nzType="primary"
                    nzSize="small"
                    nz-tooltip="Approve and auto-assign to Office Head"
                    (click)="approveAsDirector(ticket.id)"
                  >
                    Approve
                  </button>
                  <button
                    nz-button
                    nzType="default"
                    nzDanger
                    nzSize="small"
                    nz-tooltip="Disapprove this ticket"
                    (click)="openDisapproveModal(ticket.id)"
                  >
                    Disapprove
                  </button>
                }
                <a nz-button nzType="link" nzSize="small" [routerLink]="['/tickets', ticket.ticketNumber]">
                  View
                </a>
              </td>
            </tr>
          }
        </tbody>
      </nz-table>
    </div>
  </nz-spin>
</nz-card>

<ng-template #extraTemplate>
  <button nz-button nzType="default" (click)="loadTicketsForApproval()">
    Refresh
  </button>
</ng-template>

<!-- Disapprove Modal (Director) -->
<nz-modal
  [nzVisible]="showDisapproveModal()"
  (nzVisibleChange)="showDisapproveModal.set($event)"
  nzTitle="Disapprove Ticket"
  [nzOkText]="'Confirm Disapproval'"
  [nzCancelText]="'Cancel'"
  [nzOkDanger]="true"
  [nzOkLoading]="loading()"
  (nzOnOk)="confirmDisapprove()"
  (nzOnCancel)="closeDisapproveModal()"
>
  <ng-container *nzModalContent>
    <p>Please provide a reason for disapproving this ticket. This will be visible to the requester.</p>
    <div class="form-group">
      <label>Reason for Disapproval: <span class="required">*</span></label>
      <textarea
        nz-input
        [ngModel]="disapproveReason()"
        (ngModelChange)="disapproveReason.set($event)"
        rows="4"
        placeholder="Enter the reason why this ticket is being disapproved..."
      ></textarea>
    </div>
  </ng-container>
</nz-modal>

<!-- Secretary Review Modal (Approve/Reject with Notes) -->
<nz-modal
  [nzVisible]="showReviewModal()"
  (nzVisibleChange)="showReviewModal.set($event)"
  nzTitle="Review Ticket"
  [nzFooter]="reviewModalFooter"
  [nzClosable]="true"
  (nzOnCancel)="closeReviewModal()"
>
  <ng-container *nzModalContent>
    <p>Please review this ticket. You can:</p>
    <ul>
      <li><strong>Approve:</strong> Forward to Director for final approval</li>
      <li><strong>Reject:</strong> Return to requester with notes</li>
    </ul>

    <div class="form-group" style="margin-top: 16px;">
      <label>Notes/Comments: <span class="required" *ngIf="reviewAction() === 'reject'">*</span></label>
      <textarea
        nz-input
        [ngModel]="reviewComment()"
        (ngModelChange)="reviewComment.set($event)"
        rows="4"
        [placeholder]="reviewAction() === 'reject' ? 'Enter the reason for rejection (required). This will be visible to the requester...' : 'Add any comments about this ticket (optional)...'"
      ></textarea>
    </div>
  </ng-container>

  <ng-template #reviewModalFooter>
    <button nz-button nzType="default" (click)="closeReviewModal()">Cancel</button>
    <button
      nz-button
      nzType="default"
      nzDanger
      [nzLoading]="loading()"
      (click)="reviewAction.set('reject'); confirmReview()"
    >
      Reject with Notes
    </button>
    <button
      nz-button
      nzType="primary"
      [nzLoading]="loading()"
      (click)="reviewAction.set('approve'); confirmReview()"
    >
      Approve & Forward
    </button>
  </ng-template>
</nz-modal>
