<nz-spin [nzSpinning]="loading()">
  @if (ticket(); as t) {
    <div class="ticket-detail-container">
      <!-- Header Card -->
      <nz-card [nzTitle]="headerTemplate" [nzExtra]="headerActions">
        <nz-descriptions [nzColumn]="2" nzBordered>
          <nz-descriptions-item nzTitle="Ticket Number">
            {{ t.ticketNumber }}
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Type">
            <nz-tag [nzColor]="t.type === 'MIS' ? 'blue' : 'green'">
              {{ t.type }}
            </nz-tag>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Status">
            <nz-tag [nzColor]="getStatusColor(t.status)">
              {{ t.status.replace('_', ' ') }}
            </nz-tag>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Priority">
            <nz-tag [nzColor]="getPriorityColor(t.priority)">
              {{ t.priority }}
            </nz-tag>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Created By">
            {{ t.createdBy.name }} ({{ t.createdBy.email }})
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Created At">
            {{ t.createdAt | date }}
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Due Date" [nzSpan]="1">
            {{ formatDate(t.dueDate) }}
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Control Number" [nzSpan]="1">
            {{ t.controlNumber || 'N/A' }}
          </nz-descriptions-item>
        </nz-descriptions>

        <nz-divider></nz-divider>

        <h4>Description</h4>
        <p style="white-space: pre-wrap">{{ t.description }}</p>
      </nz-card>

      <!-- Approval Status Card -->
      <nz-card nzTitle="Review & Approval Workflow" class="approval-card">
        @if (ticket()?.status === 'CANCELLED') {
          <nz-alert
            nzType="error"
            nzMessage="Ticket Rejected/Cancelled"
            [nzDescription]="rejectedDescriptionTpl"
            [nzShowIcon]="true"
          ></nz-alert>
          <ng-template #rejectedDescriptionTpl>
            <div>
              <p>This ticket has been rejected or cancelled. Please check the status history for details.</p>
              @if (canReopenTicket()) {
                <button
                  nz-button
                  nzType="primary"
                  (click)="openReopenModal()"
                  style="margin-top: 12px;"
                >
                  <i nz-icon nzType="reload"></i>
                  Reopen & Resubmit Ticket
                </button>
              }
            </div>
          </ng-template>
        } @else if (isAwaitingSecretaryReview()) {
          <nz-alert
            nzType="info"
            nzMessage="For Secretary Review"
            [nzDescription]="secretaryReviewDescTpl"
            [nzShowIcon]="true"
          ></nz-alert>
          <ng-template #secretaryReviewDescTpl>
            <div>
              <p>This ticket is awaiting review by the secretary.</p>
              @if (canReviewAsSecretary()) {
                <div class="approval-actions" style="margin-top: 12px;">
                  <button
                    nz-button
                    nzType="primary"
                    (click)="openSecretaryReviewModal()"
                  >
                    <i nz-icon nzType="audit"></i>
                    Review Ticket
                  </button>
                </div>
              }
            </div>
          </ng-template>
        } @else if (isAwaitingDirectorApproval()) {
          <nz-alert
            nzType="info"
            nzMessage="Awaiting Director Approval"
            [nzDescription]="directorApprovalDescTpl"
            [nzShowIcon]="true"
          ></nz-alert>
          <ng-template #directorApprovalDescTpl>
            <div>
              <p>Secretary has reviewed. Waiting for director approval.</p>
              @if (canApproveAsDirector()) {
                <div class="approval-actions" style="margin-top: 12px;">
                  <button
                    nz-button
                    nzType="primary"
                    (click)="openDirectorApprovalModal()"
                  >
                    <i nz-icon nzType="check-circle"></i>
                    Review & Approve
                  </button>
                </div>
              }
            </div>
          </ng-template>
        } @else if (isFullyApproved()) {
          <nz-alert
            nzType="success"
            nzMessage="Fully Endorsed"
            nzDescription="This ticket has been approved and assigned to the office head."
            [nzShowIcon]="true"
          ></nz-alert>
        }

        <div class="approval-timeline">
          <nz-descriptions [nzColumn]="1" nzBordered>
            <nz-descriptions-item nzTitle="Secretary Review">
              @if (t.secretaryReviewedAt) {
                <span class="approved">
                  ✓ Reviewed on {{ formatDate(t.secretaryReviewedAt) }}
                </span>
              } @else {
                <span class="pending">For Review</span>
              }
            </nz-descriptions-item>
            <nz-descriptions-item nzTitle="Director Approval">
              @if (t.directorApprovedAt) {
                <span class="approved">
                  ✓ Approved on {{ formatDate(t.directorApprovedAt) }}
                </span>
              } @else {
                <span class="pending">Pending</span>
              }
            </nz-descriptions-item>
          </nz-descriptions>
        </div>
      </nz-card>

      <!-- Assignment Card -->
      <!-- Shows assigned staff, and if department head can assign, shows the Assign button -->
      <nz-card [nzTitle]="assignmentCardTitle" [nzExtra]="assignmentCardExtra">
        @if (t.assignments && t.assignments.length > 0) {
          <nz-descriptions [nzColumn]="1" nzBordered>
            @for (assignment of t.assignments; track assignment.user.id) {
              <nz-descriptions-item [nzTitle]="assignment.user.name">
                {{ assignment.user.role }} - Assigned {{ formatDate(assignment.assignedAt) }}
              </nz-descriptions-item>
            }
          </nz-descriptions>
        } @else {
          <nz-empty nzNotFoundContent="Not yet assigned"></nz-empty>
        }
      </nz-card>

      <!-- Assignment Card Title -->
      <ng-template #assignmentCardTitle>
        <span>Assigned Staff</span>
      </ng-template>

      <!-- Assignment Card Extra - Assign Button (visible for department heads when applicable) -->
      <ng-template #assignmentCardExtra>
        @if (canAssignTicket()) {
          <button
            nz-button
            nzType="primary"
            (click)="openAssignModal()"
          >
            <i nz-icon nzType="user-add" nzTheme="outline"></i>
            Assign Staff
          </button>
        }
      </ng-template>

      <!-- Schedule & Monitor Card -->
      @if (t.dateToVisit || t.status === 'PENDING_ACKNOWLEDGMENT' || t.status === 'SCHEDULED' || canAcknowledgeSchedule() || canAddMonitor()) {
        <nz-card nzTitle="Schedule & Monitoring" class="schedule-card">

          <!-- Pending Acknowledgment Alert (for Admin) -->
          @if (canAcknowledgeSchedule()) {
            <nz-alert
              nzType="warning"
              nzMessage="Schedule Pending Acknowledgment"
              [nzDescription]="acknowledgeDescTpl"
              [nzShowIcon]="true"
              style="margin-bottom: 16px"
            ></nz-alert>
            <ng-template #acknowledgeDescTpl>
              <div>
                <p>The department head has scheduled a visit. Please review and acknowledge.</p>
                <button
                  nz-button
                  nzType="primary"
                  (click)="openAcknowledgeModal()"
                  style="margin-top: 8px"
                >
                  <i nz-icon nzType="check-circle"></i>
                  Review Schedule
                </button>
              </div>
            </ng-template>
          }

          <!-- Add/Update Monitor Notes Action (for Department Heads) -->
          @if (canAddMonitor()) {
            <nz-alert
              nzType="info"
              [nzMessage]="t.monitorNotes ? 'Update Monitor Report' : 'Add Monitor Report'"
              [nzDescription]="monitorDescTpl"
              [nzShowIcon]="true"
              style="margin-bottom: 16px"
            ></nz-alert>
            <ng-template #monitorDescTpl>
              <div>
                <p>{{ t.monitorNotes ? 'You can update the monitor notes and recommendations.' : 'After the visit, please add monitor notes and recommendations.' }}</p>
                <button
                  nz-button
                  nzType="primary"
                  (click)="openMonitorModal()"
                  style="margin-top: 8px"
                >
                  <i nz-icon nzType="file-text"></i>
                  {{ t.monitorNotes ? 'Update Monitor Notes' : 'Add Monitor Notes' }}
                </button>
              </div>
            </ng-template>
          }

          <!-- Schedule Information Display -->
          @if (t.dateToVisit || t.targetCompletionDate) {
            <nz-descriptions [nzColumn]="2" nzBordered style="margin-bottom: 16px">
              <nz-descriptions-item nzTitle="Date to Visit">
                @if (t.dateToVisit) {
                  <span class="scheduled-date">
                    <i nz-icon nzType="calendar"></i>
                    {{ formatDateShort(t.dateToVisit) }}
                  </span>
                } @else {
                  <span class="pending">Not scheduled</span>
                }
              </nz-descriptions-item>
              <nz-descriptions-item nzTitle="Target Completion">
                @if (t.targetCompletionDate) {
                  <span class="scheduled-date">
                    <i nz-icon nzType="clock-circle"></i>
                    {{ formatDateShort(t.targetCompletionDate) }}
                  </span>
                } @else {
                  <span class="pending">Not set</span>
                }
              </nz-descriptions-item>
              <nz-descriptions-item nzTitle="Scheduled By">
                @if (t.headScheduledAt) {
                  <span class="approved">
                    ✓ Scheduled on {{ formatDate(t.headScheduledAt) }}
                  </span>
                } @else {
                  <span class="pending">-</span>
                }
              </nz-descriptions-item>
              <nz-descriptions-item nzTitle="Acknowledged By Admin">
                @if (t.adminAcknowledgedAt) {
                  <span class="approved">
                    ✓ Acknowledged on {{ formatDate(t.adminAcknowledgedAt) }}
                  </span>
                } @else if (t.status === 'PENDING_ACKNOWLEDGMENT') {
                  <span class="pending">Pending</span>
                } @else {
                  <span class="pending">-</span>
                }
              </nz-descriptions-item>
            </nz-descriptions>
          }

          <!-- Monitor Notes & Recommendations Display -->
          @if (t.monitorNotes || t.recommendations) {
            <nz-divider nzText="Monitor Report"></nz-divider>
            <div class="monitor-report">
              @if (t.monitorNotes) {
                <div class="report-section">
                  <h5><i nz-icon nzType="file-text"></i> Monitor Notes</h5>
                  <p style="white-space: pre-wrap">{{ t.monitorNotes }}</p>
                </div>
              }
              @if (t.recommendations) {
                <div class="report-section">
                  <h5><i nz-icon nzType="bulb"></i> Recommendations</h5>
                  <p style="white-space: pre-wrap">{{ t.recommendations }}</p>
                </div>
              }
              @if (t.monitoredAt) {
                <p class="monitor-timestamp">
                  <small>Monitored on {{ formatDate(t.monitoredAt) }}</small>
                </p>
              }
            </div>
          }
        </nz-card>
      }

      <!-- Work Actions Card (for assigned staff) -->
      <!-- Staff can update status, target completion date, and add comments here -->
      @if (canUpdateStatus()) {
        <nz-card nzTitle="Work Actions" class="work-actions-card">
          <div class="work-actions">
            <!-- Helpful hint about what the staff can do based on current status -->
            <p class="action-hint">
              @switch (ticket()?.status) {
                @case ('ASSIGNED') {
                  This ticket is assigned to you. Click "Start Work" to begin.
                }
                @case ('IN_PROGRESS') {
                  You're working on this ticket. Update status when done or if blocked.
                }
                @case ('ON_HOLD') {
                  This ticket is on hold. Resume work when ready.
                }
              }
            </p>

            <div class="action-buttons">
              @switch (ticket()?.status) {
                @case ('ASSIGNED') {
                  <button
                    nz-button
                    nzType="primary"
                    nzSize="large"
                    [nzLoading]="updatingStatus()"
                    (click)="quickStatusUpdate('IN_PROGRESS', 'Started working on this ticket')"
                  >
                    <i nz-icon nzType="play-circle" nzTheme="outline"></i>
                    Start Work
                  </button>
                  <!-- Update Status button - lets developer set dates and add comments -->
                  <button
                    nz-button
                    nzType="default"
                    nzSize="large"
                    (click)="openStatusModal()"
                  >
                    <i nz-icon nzType="edit" nzTheme="outline"></i>
                    Update Status & Details
                  </button>
                }
                @case ('IN_PROGRESS') {
                  <button
                    nz-button
                    nzType="primary"
                    nzSize="large"
                    [nzLoading]="updatingStatus()"
                    nz-popconfirm
                    nzPopconfirmTitle="Mark this ticket as resolved?"
                    (nzOnConfirm)="quickStatusUpdate('RESOLVED', 'Work completed')"
                  >
                    <i nz-icon nzType="check-circle" nzTheme="outline"></i>
                    Mark Resolved
                  </button>
                  <!-- Update Status button - lets developer update dates and add progress notes -->
                  <button
                    nz-button
                    nzType="default"
                    nzSize="large"
                    (click)="openStatusModal()"
                  >
                    <i nz-icon nzType="edit" nzTheme="outline"></i>
                    Update Status & Details
                  </button>
                  <button
                    nz-button
                    nzType="default"
                    nzSize="large"
                    [nzLoading]="updatingStatus()"
                    (click)="openStatusModal()"
                  >
                    <i nz-icon nzType="pause-circle" nzTheme="outline"></i>
                    Put On Hold
                  </button>
                }
                @case ('ON_HOLD') {
                  <button
                    nz-button
                    nzType="primary"
                    nzSize="large"
                    [nzLoading]="updatingStatus()"
                    (click)="quickStatusUpdate('IN_PROGRESS', 'Resumed work on this ticket')"
                  >
                    <i nz-icon nzType="play-circle" nzTheme="outline"></i>
                    Resume Work
                  </button>
                  <!-- Update Status button - lets developer update dates and add progress notes -->
                  <button
                    nz-button
                    nzType="default"
                    nzSize="large"
                    (click)="openStatusModal()"
                  >
                    <i nz-icon nzType="edit" nzTheme="outline"></i>
                    Update Status & Details
                  </button>
                  <button
                    nz-button
                    nzType="default"
                    nzSize="large"
                    [nzLoading]="updatingStatus()"
                    nz-popconfirm
                    nzPopconfirmTitle="Mark this ticket as resolved?"
                    (nzOnConfirm)="quickStatusUpdate('RESOLVED', 'Work completed')"
                  >
                    <i nz-icon nzType="check-circle" nzTheme="outline"></i>
                    Mark Resolved
                  </button>
                }
              }
            </div>
          </div>
        </nz-card>
      }

      <!-- Status History Timeline -->
      <nz-card nzTitle="Status History">
        @if (t.statusHistory && t.statusHistory.length > 0) {
          <div class="status-history-container">
          <nz-timeline>
            @for (history of t.statusHistory; track history.id) {
              <nz-timeline-item>
                <p>
                  <strong>{{ history.user.name }}</strong> changed status
                  @if (history.fromStatus) {
                    from <nz-tag [nzColor]="getStatusColor(history.fromStatus)">{{ history.fromStatus }}</nz-tag>
                  }
                  to <nz-tag [nzColor]="getStatusColor(history.toStatus)">{{ history.toStatus }}</nz-tag>
                </p>
                @if (history.comment) {
                  <p class="comment">{{ history.comment }}</p>
                }
                <p class="timestamp">{{ formatDate(history.createdAt) }}</p>
              </nz-timeline-item>
            }
          </nz-timeline>
          </div>
        } @else {
          <nz-empty nzNotFoundContent="No status changes yet"></nz-empty>
        }
      </nz-card>

      <!-- Notes Section -->
      <nz-card nzTitle="Notes & Comments">
        <!-- Add Note Form -->
        <div class="add-note-form">
          <h4>Add a Note</h4>
          <textarea
            nz-input
            [ngModel]="noteContent()"
            (ngModelChange)="noteContent.set($event)"
            placeholder="Enter your comment or note..."
            [nzAutosize]="{ minRows: 3, maxRows: 6 }"
            [disabled]="submittingNote()"
          ></textarea>

          <div class="form-actions">
            @if (canAddInternalNotes()) {
              <label nz-checkbox [ngModel]="isInternalNote()" (ngModelChange)="isInternalNote.set($event)" [disabled]="submittingNote()">
                Internal Note (only visible to staff)
              </label>
            }

            <button
              nz-button
              nzType="primary"
              (click)="submitNote()"
              [nzLoading]="submittingNote()"
              [disabled]="!noteContent().trim()"
            >
              Add Note
            </button>
          </div>
        </div>

        <nz-divider></nz-divider>

        <!-- Notes List -->
        @if (visibleNotes().length > 0) {
          <div class="notes-list">
            @for (note of visibleNotes(); track note.id) {
              <div class="note-item" [class.internal]="note.isInternal">
                <div class="note-header">
                  <strong>{{ note.user.name }}</strong>
                  <span class="note-role">({{ note.user.role }})</span>
                  @if (note.isInternal) {
                    <nz-tag nzColor="orange">Internal</nz-tag>
                  }
                  <span class="note-time">{{ formatDate(note.createdAt) }}</span>
                </div>
                <div class="note-content">{{ note.content }}</div>
              </div>
            }
          </div>
        } @else {
          <nz-empty nzNotFoundContent="No notes yet"></nz-empty>
        }
      </nz-card>
    </div>
  } @else {
    <nz-empty nzNotFoundContent="Ticket not found"></nz-empty>
  }
</nz-spin>

<ng-template #headerTemplate>
  @if (ticket(); as t) {
    <span>{{ t.title }}</span>
  }
</ng-template>

<ng-template #headerActions>
  <button nz-button routerLink="/tickets">
    Back to List
  </button>
</ng-template>

<!-- Status Update Modal (for Staff - includes optional target completion date) -->
<nz-modal
  [nzVisible]="showStatusModal()"
  (nzVisibleChange)="showStatusModal.set($event)"
  nzTitle="Update Ticket Status"
  [nzOkText]="'Update'"
  [nzCancelText]="'Cancel'"
  [nzOkLoading]="updatingStatus()"
  (nzOnOk)="confirmStatusUpdate()"
  (nzOnCancel)="closeStatusModal()"
>
  <ng-container *nzModalContent>
    <div class="status-modal-form">
      <!-- Status selection -->
      <div class="form-group">
        <label>New Status:</label>
        <nz-select
          [ngModel]="selectedStatus()"
          (ngModelChange)="selectedStatus.set($event)"
          nzPlaceHolder="Select new status"
          style="width: 100%"
        >
          @for (option of statusOptions; track option.value) {
            <nz-option [nzValue]="option.value" [nzLabel]="option.label"></nz-option>
          }
        </nz-select>
      </div>

      <!-- Target Completion Date (optional - developer can update this) -->
      <div class="form-group" style="margin-top: 12px">
        <label>Target Completion Date (optional):</label>
        <nz-date-picker
          style="width: 100%"
          [ngModel]="devTargetCompletionDate()"
          (ngModelChange)="devTargetCompletionDate.set($event)"
          nzPlaceHolder="Update target completion date"
          [nzDisabledDate]="disablePastDates"
        ></nz-date-picker>
        <p class="info-text" style="margin-top: 4px; color: #999; font-size: 12px">
          <i nz-icon nzType="info-circle" nzTheme="outline"></i>
          You can update the expected completion date here.
        </p>
      </div>

      <!-- Comment / Reason (this goes into status history and is visible to heads) -->
      <div class="form-group" style="margin-top: 12px">
        <label>Comment / Progress Notes:</label>
        <textarea
          nz-input
          [ngModel]="statusComment()"
          (ngModelChange)="statusComment.set($event)"
          rows="4"
          placeholder="Add a comment about the work progress. This will be visible to department heads and in the status history..."
        ></textarea>
        <p class="info-text" style="margin-top: 4px; color: #999; font-size: 12px">
          <i nz-icon nzType="info-circle" nzTheme="outline"></i>
          Your comment will appear in the status history and notify the department head.
        </p>
      </div>
    </div>
  </ng-container>
</nz-modal>

<!-- Reopen Ticket Modal -->
<nz-modal
  [nzVisible]="showReopenModal()"
  (nzVisibleChange)="showReopenModal.set($event)"
  nzTitle="Reopen & Resubmit Ticket"
  [nzOkText]="'Resubmit for Review'"
  [nzCancelText]="'Cancel'"
  [nzOkLoading]="reopening()"
  [nzWidth]="600"
  (nzOnOk)="confirmReopenTicket()"
  (nzOnCancel)="closeReopenModal()"
>
  <ng-container *nzModalContent>
    <nz-alert
      nzType="info"
      nzMessage="Reopen Your Ticket"
      nzDescription="You can update the description below to address the rejection reason, then resubmit for review."
      [nzShowIcon]="true"
      style="margin-bottom: 16px;"
    ></nz-alert>

    <div class="reopen-modal-form">
      <div class="form-group">
        <label><strong>Description</strong> (you can edit to address feedback):</label>
        <textarea
          nz-input
          [ngModel]="reopenDescription()"
          (ngModelChange)="reopenDescription.set($event)"
          rows="6"
          placeholder="Update your ticket description..."
        ></textarea>
      </div>

      <div class="form-group">
        <label><strong>Comment</strong> (optional - explain what you changed):</label>
        <textarea
          nz-input
          [ngModel]="reopenComment()"
          (ngModelChange)="reopenComment.set($event)"
          rows="3"
          placeholder="e.g., Updated description to clarify the issue, added more details about the problem..."
        ></textarea>
      </div>
    </div>
  </ng-container>
</nz-modal>

<!-- Secretary Review Modal -->
<nz-modal
  [nzVisible]="showSecretaryReviewModal()"
  (nzVisibleChange)="showSecretaryReviewModal.set($event)"
  nzTitle="Secretary Review"
  [nzFooter]="secretaryReviewFooter"
  [nzClosable]="true"
  [nzWidth]="550"
  (nzOnCancel)="closeSecretaryReviewModal()"
>
  <ng-container *nzModalContent>
    <p>Please review this ticket. You can:</p>
    <ul>
      <li><strong>Endorsed:</strong> Forward to the Office Head for assignment</li>
      <li><strong>Return:</strong> Send back to requester with notes for revision</li>
    </ul>

    <div class="form-group" style="margin-top: 16px;">
      <label>Notes/Comments: <span class="required" *ngIf="secretaryReviewAction() === 'reject'">*</span></label>
      <textarea
        nz-input
        [ngModel]="secretaryReviewComment()"
        (ngModelChange)="secretaryReviewComment.set($event)"
        rows="4"
        [placeholder]="secretaryReviewAction() === 'reject' ? 'Enter the reason for returning the ticket (required)...' : 'Add any comments about this ticket (optional)...'"
      ></textarea>
    </div>
  </ng-container>

  <ng-template #secretaryReviewFooter>
    <button nz-button nzType="default" (click)="closeSecretaryReviewModal()">Cancel</button>
    <button
      nz-button
      nzType="default"
      nzDanger
      [nzLoading]="processingSecretaryReview()"
      (click)="secretaryReviewAction.set('reject'); confirmSecretaryReview()"
    >
      <i nz-icon nzType="rollback"></i>
      Return with Notes
    </button>
    <button
      nz-button
      nzType="primary"
      [nzLoading]="processingSecretaryReview()"
      (click)="secretaryReviewAction.set('approve'); confirmSecretaryReview()"
    >
      <i nz-icon nzType="check"></i>
      Approve & Forward
    </button>
  </ng-template>
</nz-modal>

<!-- Director Approval Modal -->
<nz-modal
  [nzVisible]="showDirectorApprovalModal()"
  (nzVisibleChange)="showDirectorApprovalModal.set($event)"
  nzTitle="Director Approval"
  [nzFooter]="directorApprovalFooter"
  [nzClosable]="true"
  [nzWidth]="550"
  (nzOnCancel)="closeDirectorApprovalModal()"
>
  <ng-container *nzModalContent>
    <p>This ticket has been reviewed by the secretary. You can:</p>
    <ul>
      <li><strong>Approve:</strong> Approve and auto-assign to the appropriate Office Head</li>
      <li><strong>Disapprove:</strong> Return to requester with notes</li>
    </ul>

    <div class="form-group" style="margin-top: 16px;">
      <label>Notes/Comments: <span class="required" *ngIf="directorApprovalAction() === 'disapprove'">*</span></label>
      <textarea
        nz-input
        [ngModel]="directorApprovalComment()"
        (ngModelChange)="directorApprovalComment.set($event)"
        rows="4"
        [placeholder]="directorApprovalAction() === 'disapprove' ? 'Enter the reason for disapproval (required)...' : 'Add any comments about this approval (optional)...'"
      ></textarea>
    </div>
  </ng-container>

  <ng-template #directorApprovalFooter>
    <button nz-button nzType="default" (click)="closeDirectorApprovalModal()">Cancel</button>
    <button
      nz-button
      nzType="default"
      nzDanger
      [nzLoading]="processingDirectorApproval()"
      (click)="directorApprovalAction.set('disapprove'); confirmDirectorApproval()"
    >
      <i nz-icon nzType="close-circle"></i>
      Disapprove
    </button>
    <button
      nz-button
      nzType="primary"
      [nzLoading]="processingDirectorApproval()"
      (click)="directorApprovalAction.set('approve'); confirmDirectorApproval()"
    >
      <i nz-icon nzType="check-circle"></i>
      Approve & Assign
    </button>
  </ng-template>
</nz-modal>

<!-- Acknowledge Schedule Modal (for Admin) -->
<nz-modal
  [nzVisible]="showAcknowledgeModal()"
  (nzVisibleChange)="showAcknowledgeModal.set($event)"
  nzTitle="Acknowledge Schedule"
  [nzFooter]="acknowledgeModalFooter"
  [nzClosable]="true"
  [nzWidth]="550"
  (nzOnCancel)="closeAcknowledgeModal()"
>
  <ng-container *nzModalContent>
    <p>Review the scheduled visit set by the department head:</p>
    <ul>
      <li><strong>Acknowledge:</strong> Approve the schedule and notify the user</li>
      <li><strong>Reject:</strong> Return to department head for rescheduling</li>
    </ul>

    @if (acknowledgeAction() === 'acknowledge') {
      <div class="form-group" style="margin-top: 16px">
        <label>Comment (optional):</label>
        <textarea
          nz-input
          [ngModel]="acknowledgeComment()"
          (ngModelChange)="acknowledgeComment.set($event)"
          rows="3"
          placeholder="Add any notes about the acknowledgment..."
        ></textarea>
      </div>
    } @else {
      <div class="form-group" style="margin-top: 16px">
        <label><span class="required">*</span> Reason for Rejection:</label>
        <textarea
          nz-input
          [ngModel]="rejectReason()"
          (ngModelChange)="rejectReason.set($event)"
          rows="3"
          placeholder="Explain why the schedule needs to be revised..."
        ></textarea>
      </div>
    }
  </ng-container>

  <ng-template #acknowledgeModalFooter>
    <button nz-button nzType="default" (click)="closeAcknowledgeModal()">Cancel</button>
    <button
      nz-button
      nzType="default"
      nzDanger
      [nzLoading]="processingAcknowledge()"
      (click)="acknowledgeAction.set('reject'); confirmAcknowledge()"
    >
      Reject Schedule
    </button>
    <button
      nz-button
      nzType="primary"
      [nzLoading]="processingAcknowledge()"
      (click)="acknowledgeAction.set('acknowledge'); confirmAcknowledge()"
    >
      Acknowledge & Notify User
    </button>
  </ng-template>
</nz-modal>

<!-- Monitor & Recommendations Modal (for Department Heads) -->
<nz-modal
  [nzVisible]="showMonitorModal()"
  (nzVisibleChange)="showMonitorModal.set($event)"
  nzTitle="Monitor Notes & Recommendations"
  [nzOkText]="'Submit'"
  [nzCancelText]="'Cancel'"
  [nzOkLoading]="processingMonitor()"
  [nzWidth]="600"
  (nzOnOk)="confirmAddMonitor()"
  (nzOnCancel)="closeMonitorModal()"
>
  <ng-container *nzModalContent>
    <nz-alert
      nzType="info"
      nzMessage="Post-Visit Monitoring"
      nzDescription="Document your findings and recommendations after the site visit. You can update these at any time."
      [nzShowIcon]="true"
      style="margin-bottom: 16px"
    ></nz-alert>

    <!-- Developer's Status Comments (read-only reference) -->
    @if (devStatusComments().length > 0) {
      <div style="margin-bottom: 16px; background: #f6f8fa; border: 1px solid #e1e4e8; border-radius: 6px; padding: 12px;">
        <h5 style="margin: 0 0 8px 0; color: #24292e;">
          <i nz-icon nzType="message" nzTheme="outline"></i>
          Developer Notes / Comments
        </h5>
        @for (entry of devStatusComments(); track entry.id) {
          <div style="padding: 8px; background: #fff; border-radius: 4px; margin-bottom: 6px; border-left: 3px solid #1890ff;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
              <strong style="font-size: 12px; color: #586069;">{{ entry.user.name }} ({{ entry.fromStatus }} → {{ entry.toStatus }})</strong>
              <small style="color: #959da5;">{{ formatDateShort(entry.createdAt) }}</small>
            </div>
            <p style="margin: 0; white-space: pre-wrap; font-size: 13px;">{{ entry.comment }}</p>
          </div>
        }
        <p style="margin: 8px 0 0 0; font-size: 11px; color: #959da5;">
          <i nz-icon nzType="bulb" nzTheme="outline"></i>
          Use the developer's notes above as reference for your recommendations.
        </p>
      </div>
    }

    <div class="form-group" style="margin-bottom: 16px">
      <label><span class="required">*</span> Monitor Notes:</label>
      <textarea
        nz-input
        [ngModel]="monitorNotes()"
        (ngModelChange)="monitorNotes.set($event)"
        rows="5"
        placeholder="Document your observations and findings during the visit..."
      ></textarea>
    </div>

    <div class="form-group" style="margin-bottom: 16px">
      <label><span class="required">*</span> Recommendations:</label>
      <textarea
        nz-input
        [ngModel]="recommendations()"
        (ngModelChange)="recommendations.set($event)"
        rows="5"
        placeholder="Provide recommendations for the user or for future actions..."
      ></textarea>
    </div>

    <div class="form-group">
      <label>Additional Comment (optional):</label>
      <textarea
        nz-input
        [ngModel]="monitorComment()"
        (ngModelChange)="monitorComment.set($event)"
        rows="3"
        placeholder="Any additional notes or comments..."
      ></textarea>
    </div>
  </ng-container>
</nz-modal>

<!-- ========================================
     Assign Ticket Modal (for Department Heads)
     Assigns staff + schedules date to visit in one step.
     ======================================== -->
<nz-modal
  [nzVisible]="showAssignModal()"
  (nzVisibleChange)="showAssignModal.set($event)"
  nzTitle="Assign Ticket to Staff"
  [nzOkText]="'Assign & Schedule'"
  [nzCancelText]="'Cancel'"
  [nzOkLoading]="processingAssignment()"
  [nzOkDisabled]="!selectedUserId() || !assignDateToVisit()"
  [nzWidth]="550"
  (nzOnOk)="confirmAssignment()"
  (nzOnCancel)="closeAssignModal()"
>
  <ng-container *nzModalContent>
    <!-- Staff member selection (required) -->
    <div class="form-group" style="margin-bottom: 16px">
      <label><span class="required">*</span> Select Staff Member:</label>
      <nz-select
        [ngModel]="selectedUserId()"
        (ngModelChange)="selectedUserId.set($event)"
        nzPlaceHolder="Select staff member"
        nzShowSearch
        style="width: 100%"
      >
        @for (staff of staffList(); track staff.id) {
          <nz-option [nzValue]="staff.id" [nzLabel]="staff.name || staff.email"></nz-option>
        }
      </nz-select>
      @if (staffList().length === 0) {
        <p class="warning-text" style="color: #ff4d4f; margin-top: 8px">
          No staff members available. Please add developers/technical staff first.
        </p>
      }
    </div>

    <!-- Date to Visit (REQUIRED) -->
    <div class="form-group" style="margin-bottom: 16px">
      <label><span class="required">*</span> Date to Visit:</label>
      <nz-date-picker
        style="width: 100%"
        [ngModel]="assignDateToVisit()"
        (ngModelChange)="assignDateToVisit.set($event)"
        nzPlaceHolder="Select date to visit"
        [nzDisabledDate]="disablePastDates"
      ></nz-date-picker>
    </div>

    <p class="info-text" style="margin-top: 12px; color: #666; font-size: 12px">
      <i nz-icon nzType="info-circle" nzTheme="outline"></i>
      After assigning, the ticket will be sent to admin/director for acknowledgment.
      The developer will set the target completion date when they start working.
    </p>
  </ng-container>
</nz-modal>
